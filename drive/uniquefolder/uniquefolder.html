<!DOCTYPE html>
<!--
Copyright 2018 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>App-specific Folder Example</title>
  </head>
  <body>
    <p>App-specific Folder Example</p>

    <!--Button allowing user to display the file picker. Similar to using an Open menu item -->
    <button id="check_folder_status_button" style="display: none;">Check folder status</button>

    <pre id="content" style="white-space: pre-wrap;"></pre>

    <script type="text/javascript">
      // The API key obtained from the Google API Console.
      // Replace with your own API key, or your own key.
      var API_KEY = '<YOUR_API_KEY>';

      // The Client ID obtained from the Google API Console. Replace with your own Client ID.
      var CLIENT_ID = "<YOUR_CLIENT_ID>";

      // API discovery doc URL for APIs used by this example
      var DISCOVERY_DOCS = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      var SCOPES = 'https://www.googleapis.com/auth/drive.file';

      var GoogleAuth;
      var GoogleUser;
      var fileId;

      var checkFolderStatusButton = document.getElementById('check_folder_status_button');
      checkFolderStatusButton.onclick = handleCheckFolderStatusButtonClick;

      /**
       *  On load, called to load the API client library, the auth2 library, and the picker library.
       */
      function handleClientLoad() {
        gapi.load('client:auth2:picker', initClient);
      }

      /**
       *  Initializes the API client library and sets the authorization and current user.
       */
      function initClient() {
        gapi.client.init({
          client_id: CLIENT_ID,
          discoveryDocs: [DISCOVERY_DOCS],
          scope: SCOPES
        }).then(function () {
          GoogleAuth = gapi.auth2.getAuthInstance();
          GoogleUser = GoogleAuth.currentUser.get();
          checkFolderStatusButton.style.display = 'block';
        }, function(error) {
          appendPre(JSON.stringify(error, null, 2));
       });
      }

      /**
       * Ensures the user has the correct scopes prior to displaying the picker.
       */
      function handleCheckFolderStatusButtonClick() {
        if (!GoogleUser.hasGrantedScopes(SCOPES)) {
          GoogleUser.grant({
            scope: SCOPES
          }).then(verifyFolder, function(err) {
            // Handle error/declined auth...
          });
        } else {
          getOrCreateFolder();
        }
      }

      /**
       * Verify that the app-specific folder exists. If it exists, create a file in the
       * folder. If it doesn't exist, check trash. If it isn't trashed, create it.
       * Note that even though the folder has a unique key and name, its not impossible
       * to have two folderes with that key and name.
       */
      function getOrCreateFolder() {
        // Notice we use the query string parameter (q) to identify the criteria for folders to return. One criteria is that
        // the folder must have appProperties with a specific key of "myfolderkey" and value of "1234" set.  
        //
        // By default, files.list in v3 only returns a subset of all fields, such as file id. If you want specific fields returned,
        // you must request them using the fields parameter. In the following example, we ask for the trashed field to be returned.
        // By defining the fields parameter, only the fields defined by that parameter are returned (file id would no longer be
        // returned).
        gapi.client.drive.files.list({
          'q': '"me" in owners and mimeType="application/vnd.google-apps.folder" and appProperties has {key="myfolderkey" and value="1234"} and visibility="limited"',
          'fields': 'files/trashed, files/id'
        }).then(function(response) {
          var files = response.result.files;
          if (files && files.length > 0) {
            appendPre(files.length + ' folder(s) found. Checking trashed status');
            var filesCounter;
            // Cycle through all files and check if they are trashed.
            for (filesCounter=0; filesCounter < files.length; filesCounter++){
              checkTrashed(files,filesCounter);
            }
          } else {
            appendPre('Folder not found. Creating folder');
            createFolder();
          }
        });
      }
 
      /**
       * Identify whether a folder is trashed. If the folder is trashed, call untrash().
       */
      function checkTrashed(files, filesCounter) {
        if (files[filesCounter].trashed == true) {
          appendPre('Folder ' + (filesCounter+1) + ' is trashed. Untrash.');
          untrash(filesCounter);
        } else {
          appendPre('Folder ' + (filesCounter+1) + ' is not trashed.');
        }	
      }

      /**
       * Untrash a folder.
       */
      function untrash(files, filesCounter) {
        fileId = files[filesCounter].id;
        appendPre(filesCounter);
        // We set the trashed parameter to false to untrash the folder.
        gapi.client.drive.files.update({
          'fileId': 'fileId',
          'trashed': false
        }).then(function(response) {
          appendPre('Folder ' + filesCounter + ' is untrashed.');
        });
      }

      /**
       * Create a folder with appProperties including a key of "myfolderkey" and a value of "1234". The key and value are used to
       * identify an app-specific folder, such as a folder used specifically to save game data.		
       */
      function createFolder() {
        appendPre('Creating folder');
        gapi.client.drive.files.create({
          'mimeType' : 'application/vnd.google-apps.folder',
          'name' : 'mynewuniquefolder',
          'appProperties': {
            "myfolderkey": "1234"
          }
        }).then(function(response){
          appendPre('Folder created');
        });
      }
      
      /**
       * Helper method to display content to the screen.
       */
      function appendPre(message) {
        var pre = document.getElementById('content');
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
      }

    </script>

    <!-- The Google API Loader script. -->
    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  </body>
</html>
